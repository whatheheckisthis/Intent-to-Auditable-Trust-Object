# NIC Bus Audit Hook MMIO Bridge

`nic_bus_audit_hook` exposes a 64-bit `audit_event_counter` that increments when either of these conditions are observed in real time:

1. **High-frequency toggling** (TVLA-inspired): repeated high Hamming-distance transitions on `data_bus` while `bus_valid=1`.
2. **Unauthorized address pattern**: the upper half-word (`data_bus[31:16]`) falls outside a programmable allowlist window.

## Signal bundling with interfaces

The SystemVerilog implementation defines:

- `nic_bus_if`: bundles `clk`, `reset_n`, `bus_valid`, and `data_bus`.
- `axi_lite_audit_if`: bundles AXI-Lite read signals for software visibility.
- `nic_bus_audit_hook_with_if`: wrapper that maps interface fields into the core module ports.

This keeps top-level NIC integration cleaner and reduces wiring mistakes.

## AXI-Lite register map

The AXI-Lite read-only map is intentionally small:

- `base + 0x00`: `audit_event_counter[31:0]`
- `base + 0x04`: `audit_event_counter[63:32]`

Any other offset returns an AXI SLVERR-style response (`rresp=2'b10`).

## Linux MMIO mapping flow

A typical Linux integration for this register is:

1. **Describe the hardware in Device Tree** (or ACPI):
   - Assign a physical region, e.g. `reg = <0x0 0x43C00000 0x0 0x1000>;`
   - Add `compatible = "vendor,nic-bus-audit-hook-1.0";`
2. **Bind a kernel driver** (minimal platform driver):
   - Call `platform_get_resource()` and `devm_ioremap_resource()`.
   - Read low/high words with `readl(base + 0x00)` and `readl(base + 0x04)`.
   - Reconstruct `u64 counter = ((u64)hi << 32) | lo;`
3. **Export to user-space**:
   - Expose via `sysfs`, `debugfs`, or a character device ioctl.
4. **Node Exporter sidecar scraping**:
   - Either use the Node Exporter textfile collector (`*.prom`) generated by a small daemon that reads sysfs/debugfs,
   - Or use a custom exporter that emits `trust_audit_event_counter <value>`.

## Example metrics bridge (textfile collector)

A lightweight agent can periodically read `/sys/class/trust_audit/audit_event_counter` and write:

```text
# HELP trust_audit_event_counter Total suspicious NIC bus leakage events.
# TYPE trust_audit_event_counter counter
trust_audit_event_counter 9281
```

to `/var/lib/node_exporter/textfile_collector/trust_metrics.prom`.

Prometheus then scrapes Node Exporter and the metric becomes a "Trust Metric" for Grafana alerting and SLO tracking.
