services:
  lean-diagnose:
    build:
      context: ../..
      dockerfile: docker/lean-diagnose/Dockerfile
    container_name: lean-diagnose-job
    working_dir: /workspace
    command: >-
      /bin/bash -lc "
      mkdir -p /reports &&
      /workspace/formal/lean/scripts/virtual_lean_diagnose.sh 2>&1 | tee /reports/latest.log &&
      while true; do
        date -u '+%Y-%m-%dT%H:%M:%SZ' > /reports/last_run_utc.txt;
        /workspace/formal/lean/scripts/virtual_lean_diagnose.sh > /reports/latest.log 2>&1 || true;
        sleep 300;
      done"
    volumes:
      - lean_diagnose_reports:/reports

  lean-diagnose-web:
    image: python:3.12-alpine
    container_name: lean-diagnose-web
    command: sh -c "cd /reports && python -m http.server 3000"
    volumes:
      - lean_diagnose_reports:/reports:ro
    depends_on:
      - lean-diagnose

  lean-diagnose-proxy:
    image: nginx:1.27-alpine
    container_name: lean-diagnose-proxy
    depends_on:
      - lean-diagnose-web
    ports:
      - "8088:80"
    volumes:
      - ./reverse-proxy/default.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  lean_diagnose_reports:
