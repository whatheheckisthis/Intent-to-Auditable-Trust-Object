services:
  kafka:
    image: bitnami/kafka:3.7
    container_name: dpi-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_NUM_PARTITIONS=12
      - KAFKA_CFG_DEFAULT_REPLICATION_FACTOR=1
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=1
      - ALLOW_PLAINTEXT_LISTENER=yes
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 25s
    networks:
      - dpi

  redis:
    image: redis/redis-stack-server:7.2.0-v16
    container_name: dpi-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "PING"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - dpi

  packet-capture:
    build:
      context: ./capture
    container_name: dpi-capture
    network_mode: host
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=127.0.0.1:9092
      - KAFKA_TOPIC=raw.packets
      - CAPTURE_INTERFACE=any
      - BPF_FILTER=ip or ip6
      - KAFKA_BATCH_SIZE=131072
      - KAFKA_LINGER_MS=5
      - KAFKA_COMPRESSION=lz4
    cap_add:
      - NET_ADMIN
      - NET_RAW
    privileged: true
    restart: unless-stopped

  flow-processor:
    build:
      context: ./processor
    container_name: dpi-flow-processor
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=raw.packets
      - KAFKA_GROUP_ID=flow-metrics-v1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - FLUSH_INTERVAL_SECONDS=1
      - MAX_POLL_RECORDS=10000
      - RETENTION_MS=86400000
    restart: unless-stopped
    networks:
      - dpi

  traffic-generator:
    image: python:3.11-slim
    container_name: dpi-traffic-generator
    command:
      - python
      - -c
      - |
        import os, random, socket, time
        target_host = os.getenv("TARGET_HOST", "kafka")
        target_port = int(os.getenv("TARGET_PORT", "9092"))
        payload_size = int(os.getenv("PAYLOAD_SIZE", "1400"))
        rate = max(int(os.getenv("RATE_PER_SECOND", "3000")), 1)
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        payload = random.randbytes(payload_size)
        interval = 1.0 / rate
        while True:
            sock.sendto(payload, (target_host, target_port))
            time.sleep(interval)
    environment:
      - TARGET_HOST=kafka
      - TARGET_PORT=9092
      - PAYLOAD_SIZE=1300
      - RATE_PER_SECOND=5000
    networks:
      - dpi
    profiles: ["load-test"]

  grafana:
    image: grafana/grafana:11.1.4
    container_name: dpi-grafana
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=redis-datasource
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_AUTH_DISABLE_LOGIN_FORM=false
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    networks:
      - dpi

networks:
  dpi:
    driver: bridge
